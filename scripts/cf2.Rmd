---
title: "marchmadness2017"
output:
  pdf_document: default
  html_document: default
---
 
# Source Data
 
```{r}
sourcepath <- "C:/Users/Amy/Documents/GitHub/mm2017/scripts/"

# 32 seconds to do all processing
source(file = paste0(sourcepath,"proc_data.R"))

seed <- filter(seeds, Season %in% c(2002:2013))
seed$key <- paste0(seed$Season,"_",seed$Team)
seed$seedval <- as.numeric(str_extract(seed$Seed, "[0-9]{1,2}"))

seed_loser <- seed
names(seed_loser) <- paste0("L_", names(seed_loser))
seed_winner <- seed
names(seed_winner) <- paste0("W_", names(seed_winner))

tourney$key_winner <- paste0(tourney$Season,"_",tourney$Wteam)
tourney$key_loser <- paste0(tourney$Season,"_",tourney$Lteam)

tourney <- merge(tourney, seed_winner, by.x="key_winner", by.y="W_key")
tourney <- merge(tourney, seed_loser, by.x="key_loser", by.y="L_key")

tourney <- select(tourney, -W_Season, W_Seed, W_Team, L_Season, L_Seed, L_Team)
```

## FUNCTION: map pre-tourney results against actual tourney outcomes

* i.e. can regular season stats become a binary predictor for tourney matchups? If so, which ones are the best? Best = >50% predictions correct
* Assess binary outcomes e.g. does Wteam_rank > Lteam_rank = a win?
* Does Wteam_3point_avg > Lteam_3point_avg
* Predictors: 
  * Seed
* Rank
* Win_pct
* Win_pct_weighted

```{r}
head(proc_reg)
head(tourney)

proc_reg$key_winner <- paste0(proc_reg$Season,"_",proc_reg$team)
proc_reg$key_loser <- paste0(proc_reg$Season,"_",proc_reg$team)

proc_reg_winner <- proc_reg %>% ungroup %>% select(-key_loser, -Season, -team) 
names(proc_reg_winner) <- paste0("W_",names(proc_reg_winner))
proc_reg_loser <- proc_reg %>% ungroup %>% select(-key_winner, -Season, -team)
names(proc_reg_loser) <- paste0("L_",names(proc_reg_loser))

## merge winner and loser regular season data (proc_reg) to tournament results (tourney)
mod <- merge(tourney, proc_reg_winner,by.x="key_winner", by.y="W_key_winner")
mod <- merge(mod, proc_reg_loser,by.x="key_loser", by.y="L_key_loser")
## add seeds
# mod <- merge(mod, seed_winner, by.x="W_key", by.y="W_key")
# mod <- merge(mod, seed_loser, by.x="L_key", by.y="L_key")

mod$W_win_pct <- mod$W_totwin / (mod$W_totwin + mod$W_totloss)
mod$W_win_pct_weighted <- mod$W_totwin_weight / (mod$W_totwin_weight + mod$W_totloss_weight)

mod$L_win_pct <- mod$L_totwin / (mod$L_totwin + mod$L_totloss)
mod$L_win_pct_weighted <- mod$L_totwin_weight / (mod$L_totwin_weight + mod$L_totloss_weight)
``` 

# Exploratory: do the regular season stats work as better binary predictors than seed?

* e.g. Model = (Better Seed > Worse Seed) ~ Game Outcome 
* Do any of these metrics predict outcomes of tournament matches better over all games?

```{r}
# ranks
m1 <- table(mod$W_final_rank > mod$L_final_rank)
m1r <- m1[2]/sum(m1)

# seeds a 'lower' seed value (e.g. 1) should beat a 'higher' seed value (e.g. 16)
m2 <- table(mod$W_seedval < mod$L_seedval)
m2r <- m2[2]/sum(m2)
table(mod$Daynum)

tourney_compare <- function(data,val){
  W_val <- paste0("W_",val)
  L_val <- paste0("L_",val)
  out <- table(data[,W_val] > data[,L_val])
  r <- out[2]/sum(out)
  return(r)
}

tourney_compare(mod, "final_rank")
tourney_compare(mod, "seedval")

# run every variable in regular_season_results + tourney_outcome data.frame
ins <- names(mod[,c(20:49)])
# genericize the names
ins <- str_split_fixed(ins, "_", 2) #

sapply(X = c(ins[,2], "seedval"), FUN = tourney_compare, data = mod)

## do the systems break down over rounds? (Sweet 16)
tourney_compare(filter(mod, Daynum %in% c(143, 144)), "seedval")
tourney_compare(filter(mod, Daynum %in% c(143, 144)), "final_rank")

# Seed is 53% correct in round 4 (Elite Eight) -- Rank is 58%
tourney_compare(filter(mod, Daynum %in% c(145, 146)), "seedval")
tourney_compare(filter(mod, Daynum %in% c(145, 146)), "final_rank")

# Seed is 80% correct in round 5 (Final Four) -- Rank is 62.5%
tourney_compare(filter(mod, Daynum %in% c(152)), "seedval")
tourney_compare(filter(mod, Daynum %in% c(152)), "final_rank")

# Seed is 84% correct in round 5 (Final Four) -- Rank is 58%
tourney_compare(filter(mod, Daynum %in% c(154)), "seedval")
tourney_compare(filter(mod, Daynum %in% c(154)), "final_rank")
```

# Exploratory: Can Elo rank predict match outcomes better than seed for a given round?


```{r}
# convert day number to round number
round_num <- function(x) {
  switch(as.character(x), 
         "134"="0",
         "135"="0",
         "136"="1",
         "137"="1",
         "138"="2",
         "139"="2",
         "143"="3",
         "144"="3",
         "145"="4",
         "146"="4",
         "152"="5",
         "154"="6")}

mod$round_number <- as.numeric(sapply(mod$Daynum, round_num))
mod$Elo_result <- ifelse(mod$W_final_rank > mod$L_final_rank, 1, 0)
mod$seed_result <- ifelse(mod$W_seedval < mod$L_seedval, 1, 0)

ggplot(mod, aes(round_number, Elo_result)) + geom_point()

```











