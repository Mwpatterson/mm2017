---
title: "marchmadness2017"
output:
  pdf_document: default
  html_document: default
---
 
```{r}
library(plyr)
library(dplyr)
library(stringr)
library(ggplot2)
library(PlayerRatings)
library(car)
library(randomForest)
# library(gbm)
 
inpath <- "C:/Users/jroberti/Git/mm2017/data/"
    #"C:/Users/Amy/Documents/GitHub/mm2017/data/"
 
reg <- read.csv(paste0(inpath, "RegularSeasonCompactResults.csv"), stringsAsFactors = FALSE)

team <- read.csv(paste0(inpath, "Teams.csv"), stringsAsFactors = FALSE)
seasons <- read.csv(paste0(inpath, "Seasons.csv"), stringsAsFactors = FALSE)
 
tourney <- read.csv(paste0(inpath, "TourneyCompactResults.csv"), stringsAsFactors = FALSE)
 
head(reg)
 
```
## estimate ELO ratings

* Pilot 2016 season to see how to format and evaluate whether it makes sense...

```{r}
# reg2016 <- filter(reg, Season==2016)
# # assign 1 for win, 0 for loss, 0.5 for draw to team in left-most column
# reg2016$Outcome <- ifelse(reg2016$Wscore - reg2016$Lscore>0, 1, 0)

# ranks2016 <- steph(select(reg2016, Daynum, Wteam, Lteam, Outcome), history=TRUE)
# # # 
# regSeason2016 <- merge(ranks2016$ratings, team, by.x="Player", by.y="Team_Id")
# arrange(regSeason2016, desc(Rating)) %>% head(50)


#reg_ranks <- reg %>% group_by_(Season) %>% select_(Daynum, Wteam, Lteam, Outcome) %>% steph(x[,c("Daynum", "Wteam", "Lteam", "Outcome")])

reg$Outcome <- ifelse(reg$Wscore - reg$Lscore>0, 1, 0)

all_ranks <- plyr::ddply(reg, .(Season), function(x){
  yo <- steph(x[,c("Daynum", "Wteam", "Lteam", "Outcome")])
  return(yo$ratings)
})


<<<<<<< HEAD
regSeason2016 <- merge(ranks2016$ratings, team, by.x="Player", by.y="Team_Id")
arrange(regSeason2016, desc(Rating)) %>% head(300)
=======
>>>>>>> a45f9682b4520370d135b1185570338754915cf3
```

* Villanova is in top 5 for entire country (they won 2016 tourney)
* #1 ranked Kansas made it to Final Four, lost to Villanova
* Miami FL is in top 15, and made it to Elite Eight
* Maryland is in top 30, and made it to Elite Eight
* Oregon is in top 3, and made it to Final Four
* Oklahoma is in top 15 and made it to Final Four
* Texas A&M made it to Elite Eight and is in top 20
* Duke is in top 30, made it to Elite Eight
* Syracuse only potential 'Dark Horse', made it to Final Four but was not Ranked Top 30 for 2016 season

```{r}
reg$wdiff <- reg$Wscore - reg$Lscore
reg$ldiff <- reg$Lscore - reg$Wscore
 
wreg <- select(reg, Season, Daynum, Wteam, Wscore, Wloc, Numot, wdiff) %>% rename(team=Wteam,score=Wscore,loc=Wloc,diff=wdiff)
lreg <- select(reg, Season, Daynum, Lteam, Lscore, Wloc, Numot, ldiff) %>% rename(team=Lteam,score=Lscore,loc=Wloc,diff=ldiff)
 
outreg <- rbind(wreg,lreg)
outreg$outcome <- ifelse(outreg$diff > 0, "win", "loss")

 
### NEED TO TURN OFF PLYR if dplyr:: is not specified for summarise
#detach(package:plyr)
start <- Sys.time()
proc_reg <- group_by(outreg, Season, team) %>%
  ## need to make sure to use summarise from dplyr, not plyr
  dplyr::summarise(totwin=sum(str_count(outcome, "win")),  # count total wins for the season
                   totloss=sum(str_count(outcome, "loss")),
                   ## average win margin - filter out negatives (those are losses), can do stdev too with same logic
                   wdiff_avg=mean(ifelse(diff>0, as.numeric(diff), 0)),
                   ldiff_avg=mean(ifelse(diff<0, as.numeric(diff), 0)),## average loss margin
                   score_avg=mean(score),
                   score_sd=sd(score),
                   wdiff_sd=sd(ifelse(diff>0, as.numeric(diff),0)),
                   ldiff_sd=sd(ifelse(diff<0, as.numeric(diff),0))
                   )
end <- Sys.time()
end - start # takes about 2.5 seconds to run
head(proc_reg)
```


## Process Tournament Data

```{r}
tourney$wdiff <- tourney$Wscore - tourney$Lscore
tourney$ldiff <- tourney$Lscore - tourney$Wscore

wtourney <- select(tourney, Season, Daynum, Wteam, Wscore, Wloc, Numot, wdiff) %>% rename(team=Wteam,score=Wscore,loc=Wloc,diff=wdiff)
ltourney <- select(tourney, Season, Daynum, Lteam, Lscore, Wloc, Numot, ldiff) %>% rename(team=Lteam,score=Lscore,loc=Wloc,diff=ldiff)

outtourney <- rbind(wtourney,ltourney)
outtourney$outcome <- ifelse(outtourney$diff > 0, "win", "loss")

proc_tourn <- group_by(outtourney, Season, team) %>%
  ## need to make sure to use summarise from dplyr, not plyr
  dplyr::summarise(totwin=sum(str_count(outcome, "win")),  # count total wins for the season
                   totloss=sum(str_count(outcome, "loss")),
                   ## average win margin - filter out negatives (those are losses), can do stdev too with same logic
                   wdiff_avg=mean(ifelse(diff>0, as.numeric(diff), 0)),
                   ldiff_avg=mean(ifelse(diff<0, as.numeric(diff), 0)),## average loss margin
                   score_avg=mean(score),
                   score_sd=sd(score),
                   wdiff_sd=sd(ifelse(diff>0, as.numeric(diff),0)),
                   ldiff_sd=sd(ifelse(diff<0, as.numeric(diff),0))
                   )

## rename "T_" == tournament data
names(proc_tourn) <- paste0("T_",names(proc_tourn))


```

```{r}
ggplot(proc_reg, aes(totwin,wdiff_avg)) + geom_point() + geom_smooth()

```

## Execute a merge

```{r}
## make keys to match the data between the two tables
proc_reg$key <- paste0(proc_reg$Season,"_",proc_reg$team)
proc_tourn$key <- paste0(proc_tourn$T_Season,"_",proc_tourn$T_team)

## the tournament results should be the left table, because the proc_reg table 
## has results of ALL teams that played (i.e. even teams that didn't make it to the tourney)
model_dat <- merge(proc_tourn, proc_reg, by.x="key", by.y="key")

model_dat$win_pct <- model_dat$totwin / (model_dat$totwin + model_dat$totloss)
```

## try a simple model

```{r}
m1 <- lm(T_totwin ~ win_pct + wdiff_avg + ldiff_avg + wdiff_sd + ldiff_sd, data = model_dat)
summary(m1)
```

## try some viz for tourney data


```{r}
ggplot(model_dat, aes(T_totwin,win_pct)) + geom_point() 
ggplot(model_dat, aes(T_totwin,wdiff_avg)) + geom_point()
ggplot(model_dat, aes(T_totwin,wdiff_sd)) + geom_point()
```

