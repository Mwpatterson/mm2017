---
title: "marchmadness2017"
output: html_document
---
 
```{r}
library(plyr)
library(dplyr)
library(stringr)
library(ggplot2)
library(PlayerRatings)
library(car)
library(randomForest)
# library(gbm)
 
inpath <- "C:/Users/Amy/Documents/GitHub/mm2017/data/"
 
reg <- read.csv(paste0(inpath, "RegularSeasonCompactResults.csv"), stringsAsFactors = FALSE)

team <- read.csv(paste0(inpath, "Teams.csv"), stringsAsFactors = FALSE)
seasons <- read.csv(paste0(inpath, "Seasons.csv"), stringsAsFactors = FALSE)
 
tourney <- read.csv(paste0(inpath, "TourneyCompactResults.csv"), stringsAsFactors = FALSE)
 
head(reg)
 
```

## estimate ELO ratings

* Pilot 2016 season to see how to format and evaluate whether it makes sense...

```{r}
reg$Elo_Outcome <- ifelse(reg$Wscore - reg$Lscore>0, 1, 0)

all_ranks <- plyr::ddply(reg, .(Season), function(x){
  yo <- steph(x[,c("Daynum", "Wteam", "Lteam", "Elo_Outcome")], history=TRUE)
  return(yo$ratings)
})
```

* Villanova is in top 5 for entire country (they won 2016 tourney)
* #1 ranked Kansas made it to Final Four, lost to Villanova
* Miami FL is in top 15, and made it to Elite Eight
* Maryland is in top 30, and made it to Elite Eight
* Oregon is in top 3, and made it to Final Four
* Oklahoma is in top 15 and made it to Final Four
* Texas A&M made it to Elite Eight and is in top 20
* Duke is in top 30, made it to Elite Eight
* Syracuse only potential 'Dark Horse', made it to Final Four but was not Ranked Top 30 for 2016 season

```{r}
reg$wdiff <- reg$Wscore - reg$Lscore
reg$ldiff <- reg$Lscore - reg$Wscore
 
## 'Stack' the data frames to quickly count wins and losses
wreg <- select(reg, Season, Daynum, Wteam, Wscore, Wloc, Numot, wdiff) %>% rename(team=Wteam,score=Wscore,loc=Wloc,diff=wdiff)
lreg <- select(reg, Season, Daynum, Lteam, Lscore, Wloc, Numot, ldiff) %>% rename(team=Lteam,score=Lscore,loc=Wloc,diff=ldiff)
outreg <- rbind(wreg,lreg)

## count wins and losses
outreg$outcome <- ifelse(outreg$diff > 0, "win", "loss")

proc_reg <- group_by(outreg, Season, team) %>%
  dplyr::summarise(totwin=sum(str_count(outcome, "win")),
                   totloss=sum(str_count(outcome, "loss")),
                   wdiff_avg=mean(ifelse(diff>0, as.numeric(diff), 0)),
                   ldiff_avg=mean(ifelse(diff<0, as.numeric(diff), 0)),
                   score_avg=mean(score),
                   score_sd=sd(score),
                   wdiff_sd=sd(ifelse(diff>0, as.numeric(diff),0)),
                   ldiff_sd=sd(ifelse(diff<0, as.numeric(diff),0))
                   )

head(proc_reg)
```

### Determine end of season performance

```{r}
## how to pull the last N number of games
end_of_season <- outreg %>% 
  group_by(Season, team) %>% 
  arrange(Daynum) %>% 
  top_n(6, wt=Daynum) %>% 
  #summarize(last6_win=sum(Outcome))
  summarize(last6_win=sum(str_count(outcome, "win")))

# ## check the results to make sure top_n() is working as expected...
# tail(end_of_season, 20)
# filter(outreg, Season==2016, team==1447) %>% arrange(Daynum) 

end_of_season$key <- paste0(end_of_season$Season,"_",end_of_season$team)
```

## Process Tournament Data

```{r}
tourney$wdiff <- tourney$Wscore - tourney$Lscore
tourney$ldiff <- tourney$Lscore - tourney$Wscore

wtourney <- select(tourney, Season, Daynum, Wteam, Wscore, Wloc, Numot, wdiff) %>% rename(team=Wteam,score=Wscore,loc=Wloc,diff=wdiff)
ltourney <- select(tourney, Season, Daynum, Lteam, Lscore, Wloc, Numot, ldiff) %>% rename(team=Lteam,score=Lscore,loc=Wloc,diff=ldiff)

outtourney <- rbind(wtourney,ltourney)
outtourney$outcome <- ifelse(outtourney$diff > 0, "win", "loss")

proc_tourn <- group_by(outtourney, Season, team) %>%
  dplyr::summarise(totwin=sum(str_count(outcome, "win")), 
                   totloss=sum(str_count(outcome, "loss")),
                   wdiff_avg=mean(ifelse(diff>0, as.numeric(diff), 0)),
                   ldiff_avg=mean(ifelse(diff<0, as.numeric(diff), 0)),
                   score_avg=mean(score),
                   score_sd=sd(score),
                   wdiff_sd=sd(ifelse(diff>0, as.numeric(diff),0)),
                   ldiff_sd=sd(ifelse(diff<0, as.numeric(diff),0))
                   )

## rename "T_" == tournament data
names(proc_tourn) <- paste0("T_",names(proc_tourn))
```


## Execute a merge so we can model tourney_outcomes ~ reg_season_data

```{r}
## make keys to match the data between the two tables
proc_reg$key <- paste0(proc_reg$Season,"_",proc_reg$team)
proc_tourn$key <- paste0(proc_tourn$T_Season,"_",proc_tourn$T_team)

## the tournament results should be the left table, because the proc_reg table 
## has results of ALL teams that played (i.e. even teams that didn't make it to the tourney)
model_dat <- merge(proc_tourn, proc_reg, by.x="key", by.y="key")

model_dat$win_pct <- model_dat$totwin / (model_dat$totwin + model_dat$totloss)
```


```{r}
ggplot(proc_reg, aes(totwin,wdiff_avg)) + geom_point() + geom_smooth()
```

## try a simple model

```{r}
m1 <- lm(T_totwin ~ win_pct + wdiff_avg + ldiff_avg + wdiff_sd + ldiff_sd, data = model_dat)
summary(m1)
```

## try some viz for tourney data


```{r}
ggplot(model_dat, aes(T_totwin,win_pct)) + geom_point() 
ggplot(model_dat, aes(T_totwin,wdiff_avg)) + geom_point()
ggplot(model_dat, aes(T_totwin,wdiff_sd)) + geom_point()
```

